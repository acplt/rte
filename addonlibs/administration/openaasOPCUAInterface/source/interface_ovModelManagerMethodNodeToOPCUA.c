/******************************************************************************
 *
 *   FILE
 *   ----
 *   nodeStoreFunctions.c
 *
 *   History
 *   -------
 *   2014-10-21   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/

#ifndef OV_COMPILE_LIBRARY_openaasOPCUAInterface
#define OV_COMPILE_LIBRARY_openaasOPCUAInterface
#endif

#include "openaasOPCUAInterface.h"
#include "libov/ov_macros.h"
#include "ksbase.h"
#include "opcua.h"
#include "opcua_helpers.h"
#include "libov/ov_path.h"
#include "libov/ov_memstack.h"
#include "ks_logfile.h"
#include "nodeset_openaas.h"
#include "libov/ov_element.h"
#include "opcua_ovTrafo.h"

UA_StatusCode getNumericalNodeIdForInputOutputArgs(UA_Server *server,
		UA_NodeId methodId, UA_NodeId* inArgsId, UA_NodeId* outArgsId) {
	UA_BrowseDescription bD;
	UA_BrowseDescription_init(&bD);
	bD.browseDirection = UA_BROWSEDIRECTION_FORWARD;
	bD.nodeId = methodId;
	bD.referenceTypeId = UA_NODEID_NUMERIC(0, UA_NS0ID_HASPROPERTY);
	bD.includeSubtypes = false;
	UA_Boolean found1 = false;
	UA_Boolean found2 = false;

	UA_BrowseResult bR = UA_Server_browse(server, 2, &bD);
	for (size_t i = 0; i < bR.referencesSize; i++) {
		UA_QualifiedName bN;
		UA_QualifiedName_init(&bN);
		UA_Server_readBrowseName(server, bR.references[i].nodeId.nodeId, &bN);
		UA_String tmpBN = UA_String_fromChars("InputArguments");
		if (UA_String_equal(&bN.name, &tmpBN)) {
			*inArgsId = bR.references[i].nodeId.nodeId;
			found1 = true;
			//UA_NodeId_copy(&bR.references[i].nodeId.nodeId,&inArgsId);
			UA_String_deleteMembers(&tmpBN);
			UA_QualifiedName_deleteMembers(&bN);
			continue;
		}
		UA_String_deleteMembers(&tmpBN);
		tmpBN = UA_String_fromChars("OutputArguments");
		if (UA_String_equal(&bN.name, &tmpBN)) {
			*outArgsId = bR.references[i].nodeId.nodeId;
			found2 = true;
			//UA_NodeId_copy(&bR.references[i].nodeId.nodeId,&outArgsId);
			UA_String_deleteMembers(&tmpBN);
			UA_QualifiedName_deleteMembers(&bN);
			continue;
		}
		UA_String_deleteMembers(&tmpBN);
		UA_QualifiedName_deleteMembers(&bN);
	}
	UA_BrowseDescription_deleteMembers(&bD);
	UA_BrowseResult_deleteMembers(&bR);
	if (found1 && found2)
		return UA_STATUSCODE_GOOD;
	return UA_STATUSCODE_BADNOTFOUND;
}

OV_DLLFNCEXPORT UA_StatusCode openaasOPCUAInterface_interface_ovModelManagerMethodNodeToOPCUA(void *context, const UA_NodeId *nodeId, UA_Node** opcuaNode) {
	UA_Node *newNode = NULL;
	UA_StatusCode result = UA_STATUSCODE_GOOD;
	OV_PATH path;
	OV_INSTPTR_ov_object pobj = NULL;
	OV_VTBLPTR_ov_object pVtblObj = NULL;
	OV_ACCESS access;
	UA_NodeClass nodeClass;
	OV_STRING tmpString = NULL;
	OV_UINT len = 0;
	OV_UINT len2 = 0;
	OV_STRING *plist = NULL;
	OV_STRING *plist2 = NULL;
	OV_ELEMENT element;
	OV_INSTPTR_opcua_server uaserver = NULL;

	OV_INSTPTR_openaasOPCUAInterface_interface 	pInterface = Ov_StaticPtrCast(openaasOPCUAInterface_interface, context);

	// findServer
	uaserver =	Ov_StaticPtrCast(opcua_server, Ov_GetParent(opcua_serverToInterfaces, pInterface));

	if (pInterface == NULL)
		return UA_STATUSCODE_BADOUTOFSERVICE;

	opcua_helpers_copyUAStringToOV(nodeId->identifier.string, &tmpString);
	plist = ov_string_split(tmpString, "||", &len);
	plist2 = ov_string_split(plist[1], ".", &len2);
	ov_string_setvalue(&tmpString, NULL);

	UA_NodeId tmpNodeId;
	UA_NodeId_init(&tmpNodeId);
	tmpNodeId.namespaceIndex = nodeId->namespaceIndex;
	tmpNodeId.identifierType = nodeId->identifierType;

	tmpNodeId.identifier.string = UA_String_fromChars(plist[0]);

	ov_string_freelist(plist);
	ov_memstack_lock();
	result = opcua_helpers_resolveNodeIdToPath(tmpNodeId, &path);
	UA_NodeId_deleteMembers(&tmpNodeId);
	if (result != UA_STATUSCODE_GOOD) {
		ov_memstack_unlock();
		ov_string_freelist(plist2);
		return result;
	}
	element = path.elements[path.size - 1];
	ov_memstack_unlock();

	result = opcua_helpers_getVtblPointerAndCheckAccess(&element, &pobj, &pVtblObj, &access);
	if (result != UA_STATUSCODE_GOOD) {
		ov_string_freelist(plist2);
		return result;
	}

	nodeClass = UA_NODECLASS_METHOD;
	newNode = (UA_Node*) UA_calloc(1, sizeof(UA_MethodNode));

	// Basic Attribute
	// BrowseName
	UA_QualifiedName qName;
	qName.name = UA_String_fromChars(pobj->v_identifier);
	qName.namespaceIndex = nodeId->namespaceIndex;
	newNode->browseName = qName;

	// Description
	OV_STRING tempString = pVtblObj->m_getcomment(pobj, &element);
	UA_LocalizedText lText;
	UA_LocalizedText_init(&lText);
	lText.locale = UA_String_fromChars("en");
	if(tempString){
		lText.text = UA_String_fromChars(tempString);
	} else {
		lText.text = UA_String_fromChars("");
	}
	UA_LocalizedText_copy(&lText,&newNode->description);
	UA_LocalizedText_deleteMembers(&lText);

	// DisplayName
	UA_LocalizedText displayName;
	UA_LocalizedText_init(&displayName);
	displayName.locale = UA_String_fromChars("en");
	displayName.text = UA_String_fromChars(plist2[0]);
	UA_LocalizedText_copy(&displayName, &newNode->displayName);
	UA_LocalizedText_deleteMembers(&displayName);

	// NodeId
	UA_NodeId_copy(nodeId, &newNode->nodeId);

	// NodeClass
	newNode->nodeClass = nodeClass;

	// WriteMask
	UA_UInt32 writeMask = 0;
	if (element.elemtype != OV_ET_VARIABLE) {
		if (access & OV_AC_WRITE) {
			writeMask |= (1 << 2); //	BrowseName
			writeMask |= (1 << 6); //	DisplayName
		}
		if (access & OV_AC_RENAMEABLE) {
			writeMask |= (1 << 14); //	NodeId
		}
	}
	newNode->writeMask = writeMask;

	((UA_MethodNode*) newNode)->executable = TRUE;
	((UA_MethodNode*) newNode)->method = openaasOPCUAInterface_interface_MethodCallbackModelmanager;
	ov_string_setvalue((OV_STRING*) (&(((UA_MethodNode*) newNode)->context)),plist2[0]);
	ov_string_freelist(plist2);


	// Add References
	// ParentNode
	len = 0;
	plist = NULL;
	tmpString = NULL;
	opcua_helpers_copyUAStringToOV(nodeId->identifier.string, &tmpString);
	plist = ov_string_split(tmpString, "||", &len);
	UA_ExpandedNodeId NodeId = UA_EXPANDEDNODEID_STRING_ALLOC(OPCUA_OVTRAFO_DEFAULTNSINDEX, plist[0]);
	opcua_helpers_addReference(newNode, NULL, UA_NODEID_NUMERIC(0, UA_NS0ID_HASCOMPONENT),
					NodeId, UA_NODECLASS_OBJECT,
					UA_FALSE);
	ov_string_setvalue(&tmpString, NULL);
	UA_ExpandedNodeId_deleteMembers(&NodeId);

	// Type, InputArguments and OutputArguments
	UA_ExpandedNodeId NodeId2;
	UA_ExpandedNodeId NodeId3;

	if (ov_string_compare(plist[1], "createAAS") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_CREATEAAS);
	}else if (ov_string_compare(plist[1], "deleteAAS") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_DELETEAAS);
	}else if (ov_string_compare(plist[1], "createSubModel") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_CREATESUBMODEL);
	}else if (ov_string_compare(plist[1], "deleteSubModel") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_DELETESUBMODEL);
	}else if (ov_string_compare(plist[1], "createLCE") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_CREATELCE);
	}else if (ov_string_compare(plist[1], "deleteLCE") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_DELETELCE);
	}else if (ov_string_compare(plist[1], "setLCE") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_SETLCE);
	}else if (ov_string_compare(plist[1], "getLCE") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_GETLCE);
	}else if (ov_string_compare(plist[1], "setLCESimple") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_SETLCESIMPLE);
	}else if (ov_string_compare(plist[1], "getLCESimple") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_GETLCESIMPLE);
	}else if (ov_string_compare(plist[1], "getLastLCEs") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_GETLASTLCES);
	}else if (ov_string_compare(plist[1], "createPVSL") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_CREATEPVSL);
	}else if (ov_string_compare(plist[1], "deletePVSL") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_DELETEPVSL);
	}else if (ov_string_compare(plist[1], "createPVS") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_CREATEPVS);
	}else if (ov_string_compare(plist[1], "deletePVS") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_DELETEPVS);
	}else if (ov_string_compare(plist[1], "getPVS") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_GETPVS);
	}else if (ov_string_compare(plist[1], "setPVS") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_SETPVS);
	}else if (ov_string_compare(plist[1], "getAASNodeId") == OV_STRCMP_EQUAL){
		NodeId = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, UA_NSOPENAASID_GETAASNODEID);
	}else{
		NodeId = UA_EXPANDEDNODEID_NUMERIC(0,0);
		NodeId2 = UA_EXPANDEDNODEID_NUMERIC(0,0);
		NodeId3 = UA_EXPANDEDNODEID_NUMERIC(0,0);
	}

	if (NodeId.nodeId.identifier.numeric != 0){
		UA_NodeId inArgId;
		UA_NodeId_init(&inArgId);
		UA_NodeId outArgId;
		UA_NodeId_init(&outArgId);

		getNumericalNodeIdForInputOutputArgs(uaserver->v_server, UA_NODEID_NUMERIC(pInterface->v_index, NodeId.nodeId.identifier.numeric), &inArgId, &outArgId);

		NodeId2 = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, inArgId.identifier.numeric);
		NodeId3 = UA_EXPANDEDNODEID_NUMERIC(pInterface->v_index, outArgId.identifier.numeric);

		// InputArguments
		opcua_helpers_addReference(newNode, NULL, UA_NODEID_NUMERIC(0, UA_NS0ID_HASPROPERTY),
							NodeId2, UA_NODECLASS_VARIABLE,
							UA_TRUE);
		// OutputArguments
		opcua_helpers_addReference(newNode, NULL, UA_NODEID_NUMERIC(0, UA_NS0ID_HASPROPERTY),
							NodeId3, UA_NODECLASS_VARIABLE,
							UA_TRUE);
	}

	// Type
	opcua_helpers_addReference(newNode, NULL, UA_NODEID_NUMERIC(0, UA_NS0ID_HASTYPEDEFINITION),
				NodeId, UA_NODECLASS_METHOD,
				UA_TRUE);



	ov_string_freelist(plist);



	*opcuaNode = newNode;
	return UA_STATUSCODE_GOOD;
}
